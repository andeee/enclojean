(ns enclojean.esp.common-test
  (:use midje.sweet
        enclojean.esp.common)
  (:require [enclojean.esp.core :refer [esp]]
            [enclojean.bytes :as bytes]
            [gloss.io :refer [decode encode]]
            [byte-streams :refer [to-byte-buffers to-byte-array]]))

(defn unchecked-byte-vec [v]
  (vec (bytes/from-seq v)))

(defn encode-esp [decoded]
  (-> (encode esp decoded) to-byte-array bytes/to-seq))

(defn decode-esp [telegram]
  (decode esp (to-byte-buffers (bytes/from-seq telegram))))

(defn gen-encoded [command]
  (vec (map #(symbol (format "0x%02X" %)) (encode-esp command))))

(defn command [command-kw & params]
  (let [body [:packet-type :common-command :command command-kw]]
    (apply array-map
           (if (seq params)
             (concat body params)
             body))))

(tabular
 (facts "about common commands"
   (fact "encode works"
     (encode-esp (decode-esp (encode-esp ?decoded))) => (unchecked-byte-vec ?encoded))
   (fact "decode works"
     (decode-esp (encode-esp (decode-esp ?encoded))) => ?decoded))
 ?decoded                            ?encoded
 (command :write-sleep
          :sleep-period 1)           [0x55 0x00 0x05 0x00
                                      0x05 0xDB 0x01 0x00
                                      0x00 0x00 0x01 0x65]
 (command :read-version)             [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x03 0x09]
 (command :write-reset)              [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x02 0x0E]
 (command :read-sys-log)             [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x04 0x1C]
 (command :write-sys-log)            [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x05 0x1B]
 (command :write-built-in-self-test) [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x06 0x12]
 (command :write-id-base
          :base-id 0xFF800000)       [0x55 0x00 0x05 0x00
                                      0x05 0xDB 0x07 0xFF
                                      0x80 0x00 0x00 0xF3]
 (command :read-id-base)             [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x08 0x38]
 (command :write-repeater-level
          :repeater-enable :on
          :repeater-level :level-2)  [0x55 0x00 0x03 0x00
                                      0x05 0xa6 0x09 0x01
                                      0x02 0x21]
 (command :read-repeater-level)      [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x0a 0x36]
 (command :write-filter-add
          :filter-type :r-org
          :filter-value 0xCAFEBABE
          :filter-kind :apply)       [0x55 0x00 0x07 0x00
                                      0x05 0x0d 0x0b 0x01
                                      0xca 0xfe 0xba 0xbe
                                      0x80 0x9d]
 (command :write-filter-delete
          :filter-type :r-org
          :filter-value 0xcafebabe)  [0x55 0x00 0x06 0x00
                                      0x05 0x66 0x0C 0x01
                                      0xCA 0xFE 0xBA 0xBE
                                      0x01]
 (command :write-filter-delete-all)  [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x0D 0x23]
 (command :write-filter-enable
          :filter-enable :off
          :filter-operator :and)     [0x55 0x00 0x03 0x00
                                      0x05 0xA6 0x0E 0x00
                                      0x01 0x2B]
 (command :read-filters)             [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x0F 0x2D]
 (command :write-wait-maturity
          :wait-end-maturity-enable
          :on)                       [0x55 0x00 0x02 0x00
                                      0x05 0xCD 0x10 0x01
                                      0x50]
 (command :write-subtelegram
          :write-subtelegram-enable
          :off)                      [0x55 0x00 0x02 0x00
                                      0x05 0xCD 0x11 0x00
                                      0x42]
 (command :write-memory
          :memory-type :idata-ram
          :memory-address 0xCAFEBABE
          :memory-data 0x0C)         [0x55 0x00 0x07 0x00
                                      0x05 0x0D 0x12 0x03
                                      0xCA 0xFE 0xBA 0xBE
                                      0x0C 0x84]
 (command :read-memory
          :memory-type :xdata-ram
          :memory-address 0xCAFEBABE
          :data-length 0xFFFF)       [0x55 0x00 0x08 0x00
                                      0x05 0x4A 0x13 0x04
                                      0xCA 0xFE 0xBA 0xBE
                                      0xFF 0xFF 0x4D]
 (command :read-memory-address
          :memory-area
          :system-error-log)         [0x55 0x00 0x02 0x00
                                      0x05 0xCD 0x14 0x02
                                      0x0D]
 (command :read-security)            [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x15 0x6B]
 (command :write-security
          :security-level 0x03
          :key 0xEBABEFAC
          :rolling-code 0xCEBAB007) [0x55 0x00 0x0A 0x00
                                     0x05 0x9C 0x16 0x03
                                     0xEB 0xAB 0xEF 0xAC
                                     0xCE 0xBA 0xB0 0x07
                                     0x64]
 (command :write-learnmode
          :learn-mode-enable :on
          :timeout 0xCAFEBABE
          :channel 0xAA)             [0x55 0x00 0x06 0x01
                                      0x05 0x73 0x17 0x01
                                      0xCA 0xFE 0xBA 0xBE
                                      0xAA 0x07]
 (command :write-learnmode
          :learn-mode-enable :off
          :timeout 0xABCDEF01)       [0x55 0x00 0x06 0x00
                                      0x05 0x66 0x17 0x00
                                      0xAB 0xCD 0xEF 0x01
                                      0xAF]
 (command :read-learnmode)           [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x18 0x48]
 (command :write-secure-device-add
          :security-level-format 0x8A
          :device-id 0xCAFEBABE
          :private-key [0x01 0x02 0x03 0x04
                        0x05 0x06 0x07 0x08
                        0x09 0x0A 0x0B 0x0C
                        0x0D 0x0E 0x0F 0x00]
          :rolling-code [0xAB 0xCD 0xEF]
          :direction
          :outbound-table)           [0x55 0x00 0x19 0x01
                                      0x05 0x96 0x19 0x8A
                                      0xCA 0xFE 0xBA 0xBE
                                      0x01 0x02 0x03 0x04
                                      0x05 0x06 0x07 0x08
                                      0x09 0x0A 0x0B 0x0C
                                      0x0D 0x0E 0x0F 0x00
                                      0xAB 0xCD 0xEF 0x01
                                      0x2E]
 (command :write-secure-device-add
          :security-level-format 0x8A
          :device-id 0xCAFEBABE
          :private-key [0x01 0x02 0x03 0x04
                        0x05 0x06 0x07 0x08
                        0x09 0x0A 0x0B 0x0C
                        0x0D 0x0E 0x0F 0x00]
          :rolling-code
          [0xAB 0xCD 0xEF])          [0x55 0x00 0x19 0x00
                                      0x05 0x83 0x19 0x8A
                                      0xCA 0xFE 0xBA 0xBE
                                      0x01 0x02 0x03 0x04
                                      0x05 0x06 0x07 0x08
                                      0x09 0x0A 0x0B 0x0C
                                      0x0D 0x0E 0x0F 0x00
                                      0xAB 0xCD 0xEF 0x62]
 (command :write-secure-device-delete
          :device-id 0xDBAFCABE
          :direction
          :inbound-table)            [0x55 0x00 0x05 0x01
                                      0x05 0xCE 0x1A 0xDB
                                      0xAF 0xCA 0xBE 0x00
                                      0xEF]
 (command :write-secure-device-delete
          :device-id 0xDBAFCABE)     [0x55 0x00 0x05 0x00
                                      0x05 0xDB 0x1A 0xDB
                                      0xAF 0xCA 0xBE 0xFB]
 (command :read-secure-device-by-index
          :index 0x01
          :direction
          :outbound-table-broadcast) [0x55 0x00 0x02 0x01
                                      0x05 0xD8 0x1B 0x01
                                      0x02 0x55]
 (command :read-secure-device-by-index
          :index 0x01)               [0x55 0x00 0x02 0x00
                                      0x05 0xCD 0x1B 0x01
                                      0xC7]
 (command :write-mode
          :mode :advanced-mode)      [0x55 0x00 0x02 0x00
                                      0x05 0xCD 0x1C 0x01
                                      0xAC]
 (command :read-number-of-secure-devices
          :direction
          :outbound-table)           [0x55 0x00 0x01 0x01
                                      0x05 0x65 0x1D 0x01
                                      0xB9]
 (command
  :read-number-of-secure-devices)    [0x55 0x00 0x01 0x00
                                      0x05 0x70 0x1D 0x53]
 (command :read-secure-device-by-id
          :device-id 0x778899AA
          :direction
          :inbound-table)            [0x55 0x00 0x05 0x01
                                      0x05 0xCE 0x1E 0x77
                                      0x88 0x99 0xAA 0x00
                                      0x18]
 (command :read-secure-device-by-id
          :device-id 0x778899AA)     [0x55 0x00 0x05 0x00
                                      0x05 0xDB 0x1E 0x77
                                      0x88 0x99 0xAA 0x69]
 (command :write-secure-device-add-psk
          :device-id 0x12345678
          :pre-shared-key
          [0x01 0x02 0x03 0x04
           0x05 0x06 0x07 0x08
           0x09 0x0A 0x0B 0x0C
           0x0D 0x0E 0x0F 0x10])     [0x55 0x00 0x15 0x00
                                      0x05 0x79 0x1F 0x12
                                      0x34 0x56 0x78 0x01
                                      0x02 0x03 0x04 0x05
                                      0x06 0x07 0x08 0x09
                                      0x0A 0x0B 0x0C 0x0D
                                      0x0E 0x0F 0x10 0x8C]
 (command :write-secure-device-send-teachin
          :device-id 0x87654321
          :teach-in-info 0xCF)       [0x55 0x00 0x05 0x01
                                      0x05 0xCE 0x20 0x87
                                      0x65 0x43 0x21 0xCF
                                      0x7D]
 (command :write-secure-device-send-teachin
          :device-id 0x87654321)     [0x55 0x00 0x05 0x00
                                      0x05 0xDB 0x20 0x87
                                      0x65 0x43 0x21 0xB1]
 (command :write-temporary-rolling-code-window
          :rolling-code-enable :on
          :rolling-code-window
          0x708090A0)                [0x55 0x00 0x06 0x00
                                      0x05 0x66 0x21 0x01
                                      0x70 0x80 0x90 0xA0
                                      0xC1]
 (command :read-secure-device-psk
          :device-id 0xF1E2D3C4)     [0x55 0x00 0x05 0x00
                                      0x05 0xDB 0x22 0xF1
                                      0xE2 0xD3 0xC4 0x7A])
